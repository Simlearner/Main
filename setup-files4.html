<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Setup Files</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #0d0d0d; color: #f0f0f0; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #1a1a1a; }
::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #5a5a5a; }
.setup-card { background-color: #1a1a1a; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid #2d2d2d; word-break: break-word; }
.download-button { display: inline-block; padding: 0.5rem 1rem; background-color: #3b82f6; color: white; border-radius: 0.5rem; text-align: center; text-decoration: none; transition: background-color 0.3s; }
.download-button:hover { background-color: #2563eb; }
</style>
</head>
<body class="antialiased">

<!-- Firebase Config & Admin -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAy8RBotf1c-5tnH6CGMikBquROTr3W2Ho",
  authDomain: "simlearner-passwords.firebaseapp.com",
  projectId: "simlearner-passwords",
  storageBucket: "simlearner-passwords.firebasestorage.app",
  messagingSenderId: "521521557270",
  appId: "1:521521557270:web:9247fb96fd758410e76a37",
  measurementId: "G-8340L8QB2Y"
};
// 2) Admin email for the master dashboard
const ADMIN_EMAIL = ["simlearner@t-online.de", "adamsch0f1eld024@gmail.com"];
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
</script>

<!-- Header -->
<header class="py-6 px-4 md:px-8 lg:px-16 fixed w-full z-50 bg-gray-900 bg-opacity-80 backdrop-blur-sm">
  <nav class="flex justify-between items-center max-w-7xl mx-auto">
    <a href="index.html" class="flex-shrink-0">
      <img src="https://raw.githubusercontent.com/Simlearner/Main/main/assets/pictures/image01.jpg" alt="SimLearner Logo" class="h-10 rounded-lg">
    </a>
    <div id="login-status" class="text-gray-300"></div>
    <button id="logout-button" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg text-white font-bold hidden">Logout</button>
  </nav>
</header>

<!-- Login & Register -->
<section class="py-20 px-4 md:px-8 lg:px-16 pt-32 bg-gray-900">
  <div class="max-w-md mx-auto p-8 rounded-xl bg-gray-800 border border-gray-700 mb-8">
    <h2 class="text-xl font-semibold text-violet-400 mb-4 text-center">Login / Register</h2>
    <form id="login-form" class="space-y-4">
      <input type="email" id="email" placeholder="Email" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
      <input type="password" id="password" placeholder="Password" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
      <button type="submit" class="w-full px-4 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg text-white font-bold transition-colors duration-300">Login</button>
      <button type="button" id="register-button" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg text-white font-bold transition-colors duration-300">Register</button>
      <p id="login-message" class="text-center text-sm mt-2 text-red-400"></p>
    </form>
  </div>
</section>

<!-- Main Content -->
<section id="main-content" class="py-4 px-4 md:px-8 lg:px-16 bg-gray-900 hidden">
  <div class="max-w-4xl mx-auto p-4 rounded-xl bg-gray-900 bg-opacity-80">
    <h1 class="text-3xl md:text-4xl font-bold text-center text-white mb-4">Community Setup Files</h1>
    
    <!-- Upload Form -->
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 mb-4">
      <h2 class="text-xl font-semibold text-violet-400 mb-2">Upload a Setup File</h2>
      <form id="upload-form" class="space-y-4">
        <div>
          <label for="car-name" class="block text-gray-400 mb-1">Car Name</label>
          <select id="car-name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600"></select>
          <input type="text" id="car-name-text" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 mt-2 hidden" placeholder="Enter new car name">
        </div>
        <div>
          <label for="track-name" class="block text-gray-400 mb-1">Track Name</label>
          <select id="track-name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600"></select>
          <input type="text" id="track-name-text" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 mt-2 hidden" placeholder="Enter new track name">
        </div>
        <div>
          <label for="setup-file" class="block text-gray-400 mb-1">Select .json Setup File</label>
          <input type="file" id="setup-file" name="setup-file" accept=".json" class="w-full text-gray-400" required>
        </div>
        <button type="submit" id="submit-button" class="w-full px-4 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg text-white font-bold transition-colors duration-300">Upload Setup</button>
        <p id="upload-status" class="text-center text-sm mt-2"></p>
      </form>
    </div>

    <!-- Filters -->
    <div class="flex space-x-4 mb-4">
      <select id="car-filter" class="w-1/2 p-2 rounded-lg bg-gray-700 text-white border border-gray-600"></select>
      <select id="track-filter" class="w-1/2 p-2 rounded-lg bg-gray-700 text-white border border-gray-600"></select>
    </div>

    <!-- Setup List -->
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
      <div id="setups-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p id="loading-status" class="text-center text-gray-500">Loading setups...</p>
    </div>
  </div>
</section>

<script type="module">
// === Google Sheet URLs ===
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxtwFUX_R37ai9jy1kfxXpL2jcpf_3jp9prr40jn8sVLq7916bJATbKHheC6tKRJYZoKg/exec';
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1d3gbxnn92OXDIa5R6paDF699H0x6Qgr7hJOTD8Qb6HM/gviz/tq?tqx=out:json';

// === Elements ===
const loginForm=document.getElementById('login-form');
const registerButton=document.getElementById('register-button');
const logoutButton=document.getElementById('logout-button');
const loginMessage=document.getElementById('login-message');
const mainContent=document.getElementById('main-content');
const setupsList=document.getElementById('setups-list');
const loadingStatus=document.getElementById('loading-status');
const uploadForm=document.getElementById('upload-form');
const submitButton=document.getElementById('submit-button');
const carFilter=document.getElementById('car-filter');
const trackFilter=document.getElementById('track-filter');
const carDropdown=document.getElementById('car-name');
const trackDropdown=document.getElementById('track-name');
const carTextInput=document.getElementById('car-name-text');
const trackTextInput=document.getElementById('track-name-text');

// === Auth ===
auth.onAuthStateChanged(user=>{
  if(user){
    loginForm.parentElement.style.display='none';
    logoutButton.classList.remove('hidden');
    mainContent.classList.remove('hidden');
    document.getElementById('login-status').textContent=ADMIN_EMAIL.includes(user.email)?`Admin: ${user.email}`:`User: ${user.email}`;
    fetchAndDisplaySetups();
  }else{
    loginForm.parentElement.style.display='block';
    logoutButton.classList.add('hidden');
    mainContent.classList.add('hidden');
    document.getElementById('login-status').textContent='';
  }
});

loginForm.addEventListener('submit',e=>{
  e.preventDefault();
  auth.signInWithEmailAndPassword(document.getElementById('email').value,document.getElementById('password').value)
  .catch(err=>loginMessage.textContent=err.message);
});

registerButton.addEventListener('click',()=>{
  auth.createUserWithEmailAndPassword(document.getElementById('email').value,document.getElementById('password').value)
  .catch(err=>loginMessage.textContent=err.message);
});

logoutButton.addEventListener('click',()=>auth.signOut());

// === Fetch & Render ===
let allSetups=[];
async function fetchAndDisplaySetups(){
  loadingStatus.textContent='Loading setups...';
  setupsList.innerHTML='';
  try{
    const res=await fetch(GOOGLE_SHEET_URL);
    const textData=await res.text();
    const jsonText=textData.match(/\{.*\}/s)[0];
    const json=JSON.parse(jsonText);
    const rows=json.table.rows;
    allSetups=rows.map(r=>{
      const c=r.c;
      return {
        carName:c[0]?.v?.toString() || 'N/A',
        trackName:c[1]?.v?.toString() || 'N/A',
        fileName:c[2]?.v?.toString() || 'N/A',
        fileContent:c[3]?.v?.toString() || '',
        owner:c[4]?.v?.toString() || 'Admin',
        id:c[6]?.v?.toString() || ''   // <-- ID hinzufÃ¼gen (Spalte G)
      }
    });
    populateFilters();
    populateUploadDropdowns();
    renderSetups();
    loadingStatus.textContent='';
  }catch(err){
    console.error(err);
    loadingStatus.textContent='Error loading setups. Check Google Sheet URL/sharing.';
  }
}

// Populate Filter
function populateFilters(){
  const cars=['All', ...new Set(allSetups.map(s=>s.carName))];
  const tracks=['All', ...new Set(allSetups.map(s=>s.trackName))];
  carFilter.innerHTML='';
  trackFilter.innerHTML='';
  cars.forEach(c=>carFilter.innerHTML+=`<option value="${c}">${c}</option>`);
  tracks.forEach(t=>trackFilter.innerHTML+=`<option value="${t}">${t}</option>`);
  carFilter.onchange=trackFilter.onchange=renderSetups;
}

// Populate Upload Dropdowns
function populateUploadDropdowns(){
  const cars=[...new Set(allSetups.map(s=>s.carName))];
  const tracks=[...new Set(allSetups.map(s=>s.trackName))];
  carDropdown.innerHTML='';
  trackDropdown.innerHTML='';
  cars.forEach(c=>carDropdown.innerHTML+=`<option value="${c}">${c}</option>`);
  tracks.forEach(t=>trackDropdown.innerHTML+=`<option value="${t}">${t}</option>`);
  carDropdown.innerHTML+=`<option value="new">New Car</option>`;
  trackDropdown.innerHTML+=`<option value="new">New Track</option>`;
}

// Show/hide text input for new Car/Track
carDropdown.addEventListener('change',()=>{carTextInput.style.display=carDropdown.value==='new'?'block':'none';});
trackDropdown.addEventListener('change',()=>{trackTextInput.style.display=trackDropdown.value==='new'?'block':'none';});

// Render setups
function renderSetups(){
  setupsList.innerHTML='';
  const carVal=carFilter.value;
  const trackVal=trackFilter.value;
  const currentUserEmail=auth.currentUser?.email;
  const isAdmin=ADMIN_EMAIL.includes(currentUserEmail);
  allSetups.forEach(s=>{
    if((carVal==='All'||s.carName===carVal)&&(trackVal==='All'||s.trackName===trackVal)){
      const card=document.createElement('div');
      card.className='setup-card';
      let deleteBtn='';
      if(isAdmin||s.owner===currentUserEmail) deleteBtn='<button class="delete-btn px-2 py-1 bg-red-600 rounded text-white">Delete</button>';
      card.innerHTML=`
        <h3 class="text-xl font-bold text-violet-300">${s.carName}</h3>
        <p class="text-gray-400 mb-1">Track: ${s.trackName}</p>
        <p class="text-gray-400 mb-1">File: ${s.fileName}</p>
        <p class="text-gray-400 mb-2">Owner: ${s.owner}</p>
        <div class="flex space-x-2">
          <a href="data:application/json;charset=utf-8,${encodeURIComponent(s.fileContent)}" download="${s.fileName}" class="download-button">Download</a>
          ${deleteBtn}
        </div>`;
      setupsList.appendChild(card);
      if(deleteBtn) card.querySelector('.delete-btn').addEventListener('click',async ()=>{ if(confirm('Delete this setup?')) await deleteSetup(s); });
    }
  });
}

// Delete
async function deleteSetup(s){
  try{
    await fetch(GOOGLE_APPS_SCRIPT_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'delete', id: s.id})
    });
    fetchAndDisplaySetups();
  }catch(err){
    console.error(err);
   alert("Error deleting setup:\n" + JSON.stringify(s.id, null, 2));
  console.log(s);
  }
}

// Upload
uploadForm.addEventListener('submit', e=>{
  e.preventDefault();
  const carName = carDropdown.value==='new'?carTextInput.value:carDropdown.value;
  const trackName = trackDropdown.value==='new'?trackTextInput.value:trackDropdown.value;
  const file = document.getElementById('setup-file').files[0];
  if(!carName||!trackName||!file){
    document.getElementById('upload-status').textContent='Fill all fields & select a file.';
    return;
  }
  submitButton.disabled=true;
  document.getElementById('upload-status').textContent='Uploading...';
  const reader = new FileReader();
  reader.onload = async event=>{
    const fileContent = event.target.result;
    const currentUserEmail = auth.currentUser?.email || 'Admin';
    const uploadData = {carName:carName.toString(), trackName:trackName.toString(), fileName:file.name.toString(), fileContent, owner:currentUserEmail.toString()};
    try{
      await fetch(GOOGLE_APPS_SCRIPT_URL,{
        method:'POST',
        body:JSON.stringify(uploadData),
        mode:'no-cors',
        headers:{'Content-Type':'application/json'}
      });
      document.getElementById('upload-status').textContent='Setup uploaded successfully!';
      uploadForm.reset();
      carTextInput.style.display='none';
      trackTextInput.style.display='none';
      fetchAndDisplaySetups();
    }catch(err){
      console.error(err);
      document.getElementById('upload-status').textContent='Error uploading setup.';
    } finally{submitButton.disabled=false;}
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
