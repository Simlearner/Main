<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Files</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #f0f0f0;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }
        .setup-card {
            background-color: #1a1a1a;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #2d2d2d;
        }
        .download-button {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #3b82f6;
            color: white;
            border-radius: 0.5rem;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        .download-button:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="py-6 px-4 md:px-8 lg:px-16 fixed w-full z-50 bg-gray-900 bg-opacity-80 backdrop-blur-sm">
        <nav class="flex justify-between items-center max-w-7xl mx-auto">
            <a href="index.html" class="flex-shrink-0">
                <img src="https://raw.githubusercontent.com/Simlearner/Main/main/assets/pictures/image01.jpg" alt="SimLearner Logo" class="h-10 rounded-lg">
            </a>
            <a href="index.html" class="px-4 py-2 border border-gray-600 rounded-lg text-gray-300 hover:border-white hover:text-white transition-colors duration-300">Back to Main Page</a>
        </nav>
    </header>

    <!-- Setup Files Section -->
    <section class="py-20 px-4 md:px-8 lg:px-16 pt-32 bg-gray-900">
        <div class="max-w-4xl mx-auto p-8 rounded-xl bg-gray-900 bg-opacity-80">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-white mb-8">Community Setup Files</h1>
            
            <!-- Upload Form -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
                <h2 class="text-xl font-semibold text-violet-400 mb-4">Upload a Setup File</h2>
                <form id="upload-form" class="space-y-4">
                    <div>
                        <label for="car-name" class="block text-gray-400 mb-1">Car Name</label>
                        <input type="text" id="car-name" name="car-name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="e.g., Porsche 911 GT3 R" required>
                    </div>
                    <div>
                        <label for="track-name" class="block text-gray-400 mb-1">Track Name</label>
                        <input type="text" id="track-name" name="track-name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="e.g., Monza" required>
                    </div>
                    <div>
                        <label for="setup-file" class="block text-gray-400 mb-1">Select .json Setup File</label>
                        <input type="file" id="setup-file" name="setup-file" accept=".json" class="w-full text-gray-400" required>
                    </div>
                    <button type="submit" id="submit-button" class="w-full px-4 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg text-white font-bold transition-colors duration-300">Upload Setup</button>
                    <p id="upload-status" class="text-center text-sm mt-2"></p>
                </form>
            </div>
            
            <!-- List for dynamically loaded setups -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold text-violet-400 mb-4">Available Setups</h2>
                <!-- Change to a grid container for smaller, side-by-side cards -->
                <div id="setups-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Setups will be dynamically loaded here -->
                </div>
                <p id="loading-status" class="text-center text-gray-500">Loading setups...</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="max-w-5xl mx-auto px-6 py-12 text-sm text-purplebrand-300">
        <div class="glass card p-6">
            <h4 class="font-semibold mb-2">Impressum</h4>
            <p class="text-purplebrand-200 mb-2">
                Simlearner<br>
                Maximilian Luca Hummel<br>
                Rämplestrasse 6<br>
                85652 Pliening, Germany
            </p>
            <p class="text-purplebrand-200 mb-2">
                Email: <a href="mailto:simlearner@t-online.de" class="link">simlearner@t-online.de</a><br>
                Telefon: +49 151 67214780
            </p>
            <p class="text-purplebrand-200 mb-2">
                Umsatzsteuer-ID: DEXXXXXXXX (in progress)
            </p>
            <p class="text-purplebrand-200">
                Verantwortlich für den Inhalt nach § 55 Abs. 2 RStV:<br>
                Simlearner
            </p>
        </div>
    </footer>

    <script type="module">
        const uploadForm = document.getElementById('upload-form');
        const uploadStatus = document.getElementById('upload-status');
        const setupsList = document.getElementById('setups-list');
        const loadingStatus = document.getElementById('loading-status');
        const submitButton = document.getElementById('submit-button');

        // YOU MUST REPLACE THIS URL with the one from your new Google Apps Script deployment.
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxV2p3yVK6B2yuklKly7s2I-cHZ9NuZMn4m9VcNk6A2/dev';
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1d3gbxnn92OXDIa5R6paDF699H0x6Qgr7hJOTD8Qb6HM/gviz/tq?tqx=out:json';

        // Function to fetch and display the setups from the Google Sheet
        async function fetchAndDisplaySetups() {
            loadingStatus.textContent = 'Loading setups...';
            setupsList.innerHTML = ''; // Clear previous setups

            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.text();

                // The data from Google Sheets is not a standard JSON object, so we need to parse it
                const jsonText = data.substring(data.indexOf('{'), data.lastIndexOf('}') + 1);
                const json = JSON.parse(jsonText);
                const rows = json.table.rows;

                if (rows.length > 1) { // The first row is the header
                    loadingStatus.textContent = ''; // Clear loading message
                    // Iterate through each row (setup) and create a card
                    rows.slice(1).forEach(row => {
                        const columns = row.c;
                        const carName = columns[0]?.v || 'N/A';
                        const trackName = columns[1]?.v || 'N/A';
                        const fileName = columns[2]?.v || 'N/A';
                        const fileContent = columns[3]?.v || '';

                        const setupCard = document.createElement('div');
                        setupCard.className = 'setup-card';
                        setupCard.innerHTML = `
                            <h3 class="text-xl font-bold text-violet-300">${carName}</h3>
                            <p class="text-gray-400 mb-2">Track: ${trackName}</p>
                            <p class="text-gray-500 text-sm mb-4">File: ${fileName}</p>
                            <div class="flex space-x-2">
                                <a href="data:application/json;charset=utf-8,${encodeURIComponent(fileContent)}" download="${fileName}" class="download-button">Download</a>
                            </div>
                        `;
                        setupsList.appendChild(setupCard);
                    });
                } else {
                    loadingStatus.textContent = 'No setups have been uploaded yet.';
                }

            } catch (error) {
                console.error("Error fetching setups:", error);
                loadingStatus.textContent = 'Error loading setups. Please ensure your Google Sheet URL and public sharing settings are correct.';
            }
        }

        // --- Event Listener to upload setup to Google Sheet via the Apps Script ---
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const carName = document.getElementById('car-name').value;
            const trackName = document.getElementById('track-name').value;
            const fileInput = document.getElementById('setup-file');
            const file = fileInput.files[0];

            if (!carName || !trackName || !file) {
                uploadStatus.textContent = 'Please fill out all fields and select a file.';
                return;
            }

            submitButton.disabled = true;
            uploadStatus.textContent = 'Uploading setup...';

            const reader = new FileReader();
            reader.onload = async (event) => {
                const fileContent = event.target.result;
                const uploadData = {
                    carName: carName,
                    trackName: trackName,
                    fileName: file.name,
                    fileContent: fileContent
                };

                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(uploadData),
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        uploadStatus.textContent = result.message;
                        uploadForm.reset(); // Clear the form
                        fetchAndDisplaySetups(); // Refresh the list of setups
                    } else {
                        // Display the error message from the script
                        uploadStatus.textContent = result.message;
                    }

                } catch (error) {
                    console.error("Error uploading setup:", error);
                    uploadStatus.textContent = 'An error occurred during upload. Please try again.';
                } finally {
                    submitButton.disabled = false;
                }
            };
            reader.readAsText(file);
        });

        // Initial fetch of setups
        fetchAndDisplaySetups();

    </script>

</body>
</html>
