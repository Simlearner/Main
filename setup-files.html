<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Files</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #f0f0f0;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="py-6 px-4 md:px-8 lg:px-16 fixed w-full z-50 bg-gray-900 bg-opacity-80 backdrop-blur-sm">
        <nav class="flex justify-between items-center max-w-7xl mx-auto">
            <a href="index.html" class="flex-shrink-0">
                <img src="https://raw.githubusercontent.com/Simlearner/Main/main/assets/pictures/image01.jpg" alt="SimLearner Logo" class="h-10 rounded-lg">
            </a>
            <a href="index.html" class="px-4 py-2 border border-gray-600 rounded-lg text-gray-300 hover:border-white hover:text-white transition-colors duration-300">Back to Main Page</a>
        </nav>
    </header>

    <!-- Setup Files Section -->
    <section class="py-20 px-4 md:px-8 lg:px-16 pt-32 bg-gray-900">
        <div class="max-w-4xl mx-auto p-8 rounded-xl bg-gray-900 bg-opacity-80">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-white mb-8">Community Setup Files</h1>
            <p id="user-id-display" class="text-xs text-gray-500 text-center mb-4">Your User ID: </p>
            
            <!-- Upload Form -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
                <h2 class="text-xl font-semibold text-violet-400 mb-4">Upload a Setup File</h2>
                <form id="upload-form" class="space-y-4">
                    <div>
                        <label for="car-name" class="block text-gray-400 mb-1">Car Name</label>
                        <input type="text" id="car-name" name="car-name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="e.g., Porsche 911 GT3 R">
                    </div>
                    <div>
                        <label for="track-name" class="block text-gray-400 mb-1">Track Name</label>
                        <input type="text" id="track-name" name="track-name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="e.g., Monza">
                    </div>
                    <div>
                        <label for="setup-file" class="block text-gray-400 mb-1">Select .json Setup File</label>
                        <input type="file" id="setup-file" name="setup-file" accept=".json" class="w-full text-gray-400">
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg text-white font-bold transition-colors duration-300">Upload Setup</button>
                    <p id="upload-status" class="text-center text-sm mt-2"></p>
                </form>
            </div>

            <!-- Download List -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                <h2 class="text-xl font-semibold text-violet-400 mb-4">Available Setups</h2>
                <div id="setups-list" class="space-y-4">
                    <p class="text-gray-500 text-center">Loading setups...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="max-w-5xl mx-auto px-6 py-12 text-sm text-purplebrand-300">
        <div class="glass card p-6">
            <h4 class="font-semibold mb-2">Impressum</h4>
            <p class="text-purplebrand-200 mb-2">
                Simlearner<br>
                Maximilian Luca Hummel<br>
                Rämplestrasse 6<br>
                85652 Pliening, Germany
            </p>
            <p class="text-purplebrand-200 mb-2">
                Email: <a href="mailto:simlearner@t-online.de" class="link">simlearner@t-online.de</a><br>
                Telefon: +49 151 67214780
            </p>
            <p class="text-purplebrand-200 mb-2">
                Umsatzsteuer-ID: DEXXXXXXXX (in progress)
            </p>
            <p class="text-purplebrand-200">
                Verantwortlich für den Inhalt nach § 55 Abs. 2 RStV:<br>
                Simlearner
            </p>
        </div>
    </footer>

    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://pxeiohfelsbwgchjgxpu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4ZWlvaGZlbHNid2djaGpneHB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NzY2MDAsImV4cCI6MjA3MjI1MjYwMH0.SqWMWJ-WDSMaXT02fpa1K3M-IxoTqT-AKtrJ3HA3u68';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const uploadForm = document.getElementById('upload-form');
        const setupsList = document.getElementById('setups-list');
        const uploadStatus = document.getElementById('upload-status');
        const userIdDisplay = document.getElementById('user-id-display');

        let userId = null;

        // Supabase does not have an onAuthStateChanged equivalent for anonymous login
        // like Firebase. We'll simulate a user ID for demonstration purposes.
        const authenticateUser = async () => {
            try {
                const { data: { user }, error } = await supabase.auth.signInAnonymously();
                if (error) throw error;
                userId = user.id;
                userIdDisplay.textContent = `Your User ID: ${userId}`;
                fetchAndDisplaySetups();
            } catch (error) {
                console.error("Error signing in anonymously:", error);
                userIdDisplay.textContent = 'Error: Could not authenticate user.';
            }
        };

        authenticateUser();

        // Function to handle the upload
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) {
                uploadStatus.textContent = 'Authentication in progress. Please wait...';
                return;
            }

            const carName = document.getElementById('car-name').value;
            const trackName = document.getElementById('track-name').value;
            const fileInput = document.getElementById('setup-file');
            const file = fileInput.files[0];

            if (!carName || !trackName || !file) {
                uploadStatus.textContent = 'Please fill out all fields and select a file.';
                return;
            }

            try {
                uploadStatus.textContent = 'Uploading...';

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const fileContent = event.target.result;
                    
                    const { data, error } = await supabase
                        .from('setups')
                        .insert([
                            {
                                car_name: carName,
                                track_name: trackName,
                                file_name: file.name,
                                file_content: fileContent,
                                uploaded_by: userId
                            }
                        ]);

                    if (error) throw error;
                    
                    uploadStatus.textContent = 'Setup uploaded successfully!';
                    uploadForm.reset();
                };
                reader.readAsText(file);

            } catch (error) {
                console.error("Error uploading document:", error);
                uploadStatus.textContent = 'Error uploading setup. Please try again.';
            }
        });

        // Function to fetch and display setups in real-time
        async function fetchAndDisplaySetups() {
            try {
                // Fetch setups, ordered by car name
                const { data: setups, error } = await supabase
                    .from('setups')
                    .select('*')
                    .order('car_name', { ascending: true });

                if (error) throw error;
                
                setupsList.innerHTML = '';
                if (setups.length === 0) {
                    setupsList.innerHTML = '<p class="text-gray-500 text-center">No setups have been uploaded yet.</p>';
                }

                setups.forEach((setup) => {
                    const item = document.createElement('div');
                    item.className = 'flex flex-col sm:flex-row justify-between items-center bg-gray-700 p-4 rounded-lg shadow-md border border-gray-600';
                    item.innerHTML = `
                        <div>
                            <p class="text-white font-bold">${setup.car_name} - ${setup.track_name}</p>
                            <p class="text-gray-400 text-sm">Uploaded by: ${setup.uploaded_by.substring(0, 8)}... (${setup.file_name})</p>
                        </div>
                        <button class="download-button mt-4 sm:mt-0 px-4 py-2 bg-violet-500 hover:bg-violet-600 rounded-lg text-white font-bold transition-colors duration-300" data-content='${JSON.stringify(setup.file_content)}' data-filename="${setup.file_name}">
                            Download
                        </button>
                    `;
                    setupsList.appendChild(item);
                });
            } catch (error) {
                console.error("Error fetching setups:", error);
                setupsList.innerHTML = '<p class="text-red-400 text-center">Error loading setups. Please ensure your Supabase configuration and database table are correct.</p>';
            }
        }
        
        // Function to handle the download
        setupsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('download-button')) {
                const button = e.target;
                const fileContent = JSON.parse(button.dataset.content);
                const fileName = button.dataset.filename;

                const blob = new Blob([fileContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });
    </script>

</body>
</html>
