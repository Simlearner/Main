<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const GOOGLE_SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwLUWFvzXvew8CisVXqu-hAkXNBIzWUHMiRT-IS5g2YTM1PQteuessv9PH7EIdANz4I/exec";

// Elemente & globale Variablen (bleiben gleich)
const mapElement = document.getElementById('map');
const setPinButton = document.getElementById('setPinButton');
const nicknameListDiv = document.getElementById('nicknameList');
const searchLocationInput = document.getElementById('searchLocationInput');
const searchResultDiv = document.getElementById('searchResult');
const pinCountSpan = document.getElementById('pinCount');
const noPinsMessage = document.getElementById('noPinsMessage');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalInput = document.getElementById('modalInput');
const modalConfirm = document.getElementById('modalConfirm');
const modalCancel = document.getElementById('modalCancel');

let map, markers, userPins = [], currentPinningNickname = null, highlightedMarker = null, selectedSidebarItem = null;

// Modal-Funktion (bleibt gleich)
function showModal(title, message, isInput=false, confirmCallback=null, isSpinner=false){
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalInput.value='';
    modalInput.classList.toggle('hidden', !isInput);
    modalConfirm.classList.toggle('hidden', isSpinner);
    modalCancel.classList.toggle('hidden', isSpinner || !isInput);

    if(isSpinner){
        modalMessage.innerHTML = `<p class="flex items-center justify-center space-x-2">${message} <svg class="animate-spin h-5 w-5 text-purple-400 ml-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></p>`;
    } else { modalMessage.textContent = message; }

    modalConfirm.onclick = () => { modal.classList.add('hidden'); if(confirmCallback) confirmCallback(isInput?modalInput.value:null); };
    modalCancel.onclick = () => { modal.classList.add('hidden'); currentPinningNickname=null; };
    modalConfirm.textContent = isInput?'Weiter':'OK';
    modalCancel.classList.toggle('hidden', isSpinner || !isInput);
    modal.classList.remove('hidden');
}


// --- START: Geänderte Logik für Google Sheet ---

// Neuen Pin zum Google Sheet hinzufügen
async function savePinToGoogleSheet(pin) {
    try {
        const res = await fetch(GOOGLE_SHEET_API_URL, {
            method: "POST",
            body: JSON.stringify(pin),
            headers: { "Content-Type": "application/json" }
        });
        if (!res.ok) {
            throw new Error(`Fehler beim Speichern: ${await res.text()}`);
        }
        console.log("Google Sheet Antwort:", await res.text());
    } catch (error) {
        console.error("Fehler beim Senden an Google Sheets:", error);
        throw error; // Fehler weiterleiten
    }
}

// ALLE Pins vom Google Sheet abrufen und die Karte aktualisieren
async function fetchAllPinsFromGoogleSheet() {
    try {
        showModal('Daten werden geladen', 'Lade Pins von RaceNet...', false, null, true);
        const res = await fetch(GOOGLE_SHEET_API_URL); 
        
        if (!res.ok) {
            throw new Error(`HTTP-Fehler! Status: ${res.status}`);
        }
        
        const fetchedPins = await res.json();
        userPins = fetchedPins; 
        
        modal.classList.add('hidden'); 
        updateMapAndSidebar(); 
    } catch (error) {
        console.error("Fehler beim Abrufen der Pins vom Google Sheet:", error);
        showModal('Ladefehler', 'Konnte die Pins nicht vom Server laden. Versuche es später erneut.');
        userPins = []; 
        updateMapAndSidebar();
    }
}

// Neuen Pin hinzufügen und Karte neu laden
function addPin(nickname, lat, lng, country, continent){
    if(userPins.some(p=>p.nickname.toLowerCase()===nickname.toLowerCase())){
        showModal('Fehler', `Der Nickname "${nickname}" existiert bereits.`); return;
    }
    const pin={nickname, lat, lng, country, continent};
    
    // Sende an Google Sheet und lade dann die Daten neu
    showModal('Speichervorgang', `Speichere Pin für ${nickname}...`, false, null, true);
    savePinToGoogleSheet(pin)
        .then(() => {
            // Nach erfolgreichem Speichern ALLE Pins neu laden (inkl. des neuen)
            showModal('Erfolg!', `Willkommen, ${nickname}! Dein Standort (${country}) wurde gespeichert. Lade Daten neu...`);
            // Ruft fetchAllPinsFromGoogleSheet auf, welches dann updateMapAndSidebar aufruft
            fetchAllPinsFromGoogleSheet(); 
        })
        .catch(error => {
            showModal('Speicherfehler', `Pin konnte nicht gespeichert werden: ${error.message}`);
            console.error('Speicherfehler:', error);
        });
}
// --- ENDE: Geänderte Logik für Google Sheet ---


// Map initialisieren (Aufruf geändert)
function initMap(){
    map=L.map('map',{worldCopyJump:true}).setView([20,0],2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
        attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains:'abcd', maxZoom:18
    }).addTo(map);
    markers=L.markerClusterGroup({showCoverageOnHover:false,zoomToBoundsOnClick:true,spiderfyOnMaxZoom:true});
    map.addLayer(markers);
    map.on('click', onMapClick);
    
    // Daten beim Start vom Sheet abrufen
    fetchAllPinsFromGoogleSheet(); 
}

// Custom Pin (bleibt gleich)
function createCustomPin(content='•', isHighlighted=false){ return L.divIcon({className:`custom-pin ${isHighlighted?'highlight-pin':''}`, html:content, iconSize:isHighlighted?[30,30]:[20,20], iconAnchor:isHighlighted?[15,30]:[10,20]}); }

// Map & Sidebar aktualisieren (bleibt gleich, arbeitet aber mit den aus dem Sheet geladenen userPins)
function updateMapAndSidebar(){
    markers.clearLayers();
    nicknameListDiv.innerHTML='';
    highlightedMarker=null; selectedSidebarItem=null;
    if(userPins.length===0){ pinCountSpan.textContent='0'; noPinsMessage.classList.remove('hidden'); return; }
    noPinsMessage.classList.add('hidden'); pinCountSpan.textContent=userPins.length;
    userPins.forEach(pin=>{
        const marker=L.marker([pin.lat,pin.lng],{icon:createCustomPin(), pinData:pin}).bindPopup(`<b>${pin.nickname}</b><br>Ort: ${pin.country || 'Unbekannt'}`);
        markers.addLayer(marker);
        const listItem=document.createElement('div');
        listItem.className='sidebar-pin p-2 bg-gray-700 rounded-lg hover:bg-purple-800 transition duration-150 flex justify-between items-center';
        listItem.dataset.nickname=pin.nickname;
        listItem.innerHTML=`<span class="font-medium">${pin.nickname}</span> <span class="text-sm text-gray-400">${pin.country}</span>`;
        listItem.addEventListener('click',()=>togglePinHighlightAndZoom(pin,listItem));
        nicknameListDiv.appendChild(listItem);
    });
}

// Pin Highlight & Sidebar Toggle (bleibt gleich)
function togglePinHighlightAndZoom(pin, sidebarItem){
    const isCurrentlySelected = selectedSidebarItem===sidebarItem;
    if(highlightedMarker) highlightedMarker.setIcon(createCustomPin());
    if(selectedSidebarItem){ selectedSidebarItem.classList.remove('bg-purple-600','text-white'); selectedSidebarItem.classList.add('bg-gray-700','hover:bg-purple-800'); selectedSidebarItem=null; }
    if(!isCurrentlySelected){
        let found=null;
        markers.eachLayer(l=>{if(l.options.pinData&&l.options.pinData.nickname===pin.nickname){found=l;}});
        if(found){highlightedMarker=found; highlightedMarker.setIcon(createCustomPin('★',true)); map.flyTo([pin.lat,pin.lng],8); highlightedMarker.openPopup();}
        selectedSidebarItem=sidebarItem;
        selectedSidebarItem.classList.remove('bg-gray-700','hover:bg-purple-800'); selectedSidebarItem.classList.add('bg-purple-600','text-white');
        searchResultDiv.textContent=`Pin von ${pin.nickname} hervorgehoben.`;
    } else { searchResultDiv.textContent='Hervorhebung aufgehoben.'; }
}

// Reverse Geocoding (bleibt gleich)
async function reverseGeocode(lat,lng){
    try{
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1&accept-language=de`);
        const data = await res.json();
        const address=data.address;
        const country=address.country||'Unbekannt';
        let continent='Unbekannter Kontinent';
        if(address.continent) continent=address.continent.replace(/ Continent$/,'');
        else if(address.country_code){
            const cc=address.country_code.toUpperCase();
            const m={'DE':'Europa','FR':'Europa','GB':'Europa','ES':'Europa','IT':'Europa','PL':'Europa','US':'Nordamerika','CA':'Nordamerika','MX':'Nordamerika','JP':'Asien','CN':'Asien','IN':'Asien','KR':'Asien','EG':'Afrika','ZA':'Afrika','NG':'Afrika','BR':'Südamerika','AR':'Südamerika','CO':'Südamerika','AU':'Australien','NZ':'Australien'};
            continent=m[cc]||continent;
        }
        return {country,continent};
    }catch(e){ console.error(e); return {country:'Fehler',continent:'Fehler'}; }
}

// Pin setzen Flow (bleibt gleich)
setPinButton.addEventListener('click',()=>{
    showModal('Nickname eingeben','Bitte gib deinen einzigartigen Nickname ein, um fortzufahren.',true,(nickname)=>{
        if(!nickname){showModal('Abgebrochen','Nickname-Eingabe abgebrochen.'); return;}
        if(userPins.some(p=>p.nickname.toLowerCase()===nickname.toLowerCase())){showModal('Fehler',`"${nickname}" ist bereits vergeben.`); currentPinningNickname=null; return;}
        currentPinningNickname=nickname;
        showModal('Karte klicken',`Hallo, ${nickname}! Klicke nun auf die Karte, um deinen Wohnort zu markieren.`);
    });
});

async function onMapClick(e){
    if(!currentPinningNickname) return;
    const {lat,lng}=e.latlng; const nickname=currentPinningNickname;
    showModal('Standort wird ermittelt',`Suche nach Land und Kontinent für ${lat.toFixed(2)}, ${lng.toFixed(2)}...`,false,null,true);
    const location=await reverseGeocode(lat,lng);
    if(location.country.includes('Fehler')) showModal('Fehler beim Standort',`Konnte Standort für ${nickname} nicht ermitteln.`);
    else addPin(nickname,lat,lng,location.country,location.continent);
    currentPinningNickname=null;
}

// Suche / Filter (bleibt gleich)
searchLocationInput.addEventListener('input',()=>{
    const q=searchLocationInput.value.trim().toLowerCase();
    if(q.length===0){document.querySelectorAll('.sidebar-pin').forEach(i=>i.classList.remove('hidden')); pinCountSpan.textContent=userPins.length; searchResultDiv.textContent=''; return;}
    let matches=0;
    document.querySelectorAll('.sidebar-pin').forEach(i=>{
        const pin=userPins.find(p=>p.nickname===i.dataset.nickname);
        const match=pin&&(pin.country.toLowerCase().includes(q)||pin.continent.toLowerCase().includes(q));
        if(match){i.classList.remove('hidden'); matches++;}else{i.classList.add('hidden'); if(selectedSidebarItem===i) togglePinHighlightAndZoom(pin,i);}
    });
    searchResultDiv.textContent=matches>0?`${matches} Pins in der Region angezeigt.`:'Keine Pins in der Region gefunden.';
    pinCountSpan.textContent=matches;
});

window.onload=initMap;
</script>
