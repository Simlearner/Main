<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globale Community-Karte | RaceNet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        :root { --map-height: calc(100vh - 80px); }
        body { font-family: 'Inter', sans-serif; background-color: #000; color: #e4e4e7; }
        #map { height: var(--map-height); border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); }
        .custom-pin { background-color: #9333ea; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 2px solid #c084fc; font-size: 10px; font-weight: bold; }
        .highlight-pin { background-color: #f87171; color: white; border: 3px solid #fecaca; width: 30px; height: 30px; line-height: 24px; font-size: 14px; }
        .racing-flag { background-image: linear-gradient(45deg,#1f2937 25%,transparent 25%),linear-gradient(-45deg,#1f2937 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#1f2937 75%),linear-gradient(-45deg,transparent 75%,#1f2937 75%); background-size:10px 10px; background-position:0 0,0 10px,10px -10px,-10px 0; }
        .sidebar-pin { cursor: pointer; transition: all 0.2s ease-in-out; }
        .sidebar-pin:not(.bg-purple-600):hover { background-color: #4c1d95; transform: translateX(5px); }
    </style>
</head>
<body class="antialiased h-screen flex flex-col">

<header class="bg-gray-900 shadow-xl p-4 flex justify-between items-center racing-flag">
    <h1 class="text-3xl font-bold text-white tracking-widest"><span class="text-purple-400">RaceNet</span> | Globale Community</h1>
    <button id="setPinButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">üèÅ Nadel setzen</button>
</header>

<main class="flex flex-1 overflow-hidden p-4 space-x-4">
    <aside class="w-1/4 max-w-xs bg-gray-800 p-4 rounded-xl shadow-2xl flex flex-col space-y-4 overflow-y-auto">
        <h2 class="text-xl font-semibold text-purple-400 border-b border-purple-500 pb-2">Benutzer (Pins: <span id="pinCount">0</span>)</h2>
        <div class="space-y-2">
            <input type="text" id="searchLocationInput" placeholder="Suche Kontinent/Land..." class="w-full p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500 border-transparent">
            <div id="searchResult" class="text-sm text-center font-medium"></div>
        </div>
        <div id="nicknameList" class="space-y-1 overflow-y-auto flex-1">
            <p id="noPinsMessage" class="text-gray-400 text-sm italic">Noch keine Pins gesetzt.</p>
        </div>
    </aside>
    <section class="flex-1 min-w-0">
        <div id="map" class="w-full rounded-xl"></div>
    </section>
</main>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4 border-2 border-purple-600">
        <h3 id="modalTitle" class="text-xl font-bold text-purple-400"></h3>
        <p id="modalMessage" class="text-white"></p>
        <input type="text" id="modalInput" placeholder="Dein Nickname" class="w-full p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500 border-transparent">
        <div class="flex justify-end space-x-3">
            <button id="modalCancel" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg transition duration-150">Abbrechen</button>
            <button id="modalConfirm" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Best√§tigen</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const GOOGLE_SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwLUWFvzXvew8CisVXqu-hAkXNBIzWUHMiRT-IS5g2YTM1PQteuessv9PH7EIdANz4I/exec"; // <-- Hier Web-App-URL einf√ºgen

async function savePinToGoogleSheet(pin) {
    try {
        const res = await fetch(GOOGLE_SHEET_API_URL, {
            method: "POST",
            body: JSON.stringify(pin),
            headers: { "Content-Type": "application/json" }
        });
        const text = await res.text();
        console.log("Google Sheet Antwort:", text);
    } catch (error) {
        console.error("Fehler beim Senden an Google Sheets:", error);
    }
}

// Elemente & globale Variablen
const mapElement = document.getElementById('map');
const setPinButton = document.getElementById('setPinButton');
const nicknameListDiv = document.getElementById('nicknameList');
const searchLocationInput = document.getElementById('searchLocationInput');
const searchResultDiv = document.getElementById('searchResult');
const pinCountSpan = document.getElementById('pinCount');
const noPinsMessage = document.getElementById('noPinsMessage');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalInput = document.getElementById('modalInput');
const modalConfirm = document.getElementById('modalConfirm');
const modalCancel = document.getElementById('modalCancel');

let map, markers, userPins = [], currentPinningNickname = null, highlightedMarker = null, selectedSidebarItem = null;

// Modal-Funktion
function showModal(title, message, isInput=false, confirmCallback=null, isSpinner=false){
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalInput.value='';
    modalInput.classList.toggle('hidden', !isInput);
    modalConfirm.classList.toggle('hidden', isSpinner);
    modalCancel.classList.toggle('hidden', isSpinner || !isInput);

    if(isSpinner){
        modalMessage.innerHTML = `<p class="flex items-center justify-center space-x-2">${message} <svg class="animate-spin h-5 w-5 text-purple-400 ml-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></p>`;
    } else { modalMessage.textContent = message; }

    modalConfirm.onclick = () => { modal.classList.add('hidden'); if(confirmCallback) confirmCallback(isInput?modalInput.value:null); };
    modalCancel.onclick = () => { modal.classList.add('hidden'); currentPinningNickname=null; };
    modalConfirm.textContent = isInput?'Weiter':'OK';
    modalCancel.classList.toggle('hidden', isSpinner || !isInput);
    modal.classList.remove('hidden');
}

// LocalStorage laden/speichern
function loadPins(){
    try{
        const stored = localStorage.getItem('raceNetUserPins');
        if(stored) userPins = JSON.parse(stored);
    }catch{userPins=[];}
}
function savePins(){ localStorage.setItem('raceNetUserPins', JSON.stringify(userPins)); }

// Neuen Pin hinzuf√ºgen + in Google Sheet schreiben
function addPin(nickname, lat, lng, country, continent){
    if(userPins.some(p=>p.nickname.toLowerCase()===nickname.toLowerCase())){
        showModal('Fehler', `Der Nickname "${nickname}" existiert bereits.`); return;
    }
    const pin={nickname, lat, lng, country, continent};
    userPins.push(pin);
    savePins();
    savePinToGoogleSheet(pin);
    updateMapAndSidebar();
    showModal('Erfolg!', `Willkommen, ${nickname}! Dein Standort (${country}) wurde gespeichert.`);
}

// Map initialisieren
function initMap(){
    map=L.map('map',{worldCopyJump:true}).setView([20,0],2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
        attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains:'abcd', maxZoom:18
    }).addTo(map);
    markers=L.markerClusterGroup({showCoverageOnHover:false,zoomToBoundsOnClick:true,spiderfyOnMaxZoom:true});
    map.addLayer(markers);
    map.on('click', onMapClick);
    loadPins();
    updateMapAndSidebar();
}

// Custom Pin
function createCustomPin(content='‚Ä¢', isHighlighted=false){ return L.divIcon({className:`custom-pin ${isHighlighted?'highlight-pin':''}`, html:content, iconSize:isHighlighted?[30,30]:[20,20], iconAnchor:isHighlighted?[15,30]:[10,20]}); }

// Map & Sidebar aktualisieren
function updateMapAndSidebar(){
    markers.clearLayers();
    nicknameListDiv.innerHTML='';
    highlightedMarker=null; selectedSidebarItem=null;
    if(userPins.length===0){ pinCountSpan.textContent='0'; noPinsMessage.classList.remove('hidden'); return; }
    noPinsMessage.classList.add('hidden'); pinCountSpan.textContent=userPins.length;
    userPins.forEach(pin=>{
        const marker=L.marker([pin.lat,pin.lng],{icon:createCustomPin(), pinData:pin}).bindPopup(`<b>${pin.nickname}</b><br>Ort: ${pin.country || 'Unbekannt'}`);
        markers.addLayer(marker);
        const listItem=document.createElement('div');
        listItem.className='sidebar-pin p-2 bg-gray-700 rounded-lg hover:bg-purple-800 transition duration-150 flex justify-between items-center';
        listItem.dataset.nickname=pin.nickname;
        listItem.innerHTML=`<span class="font-medium">${pin.nickname}</span> <span class="text-sm text-gray-400">${pin.country}</span>`;
        listItem.addEventListener('click',()=>togglePinHighlightAndZoom(pin,listItem));
        nicknameListDiv.appendChild(listItem);
    });
}

// Pin Highlight & Sidebar Toggle
function togglePinHighlightAndZoom(pin, sidebarItem){
    const isCurrentlySelected = selectedSidebarItem===sidebarItem;
    if(highlightedMarker) highlightedMarker.setIcon(createCustomPin());
    if(selectedSidebarItem){ selectedSidebarItem.classList.remove('bg-purple-600','text-white'); selectedSidebarItem.classList.add('bg-gray-700','hover:bg-purple-800'); selectedSidebarItem=null; }
    if(!isCurrentlySelected){
        let found=null;
        markers.eachLayer(l=>{if(l.options.pinData&&l.options.pinData.nickname===pin.nickname){found=l;}});
        if(found){highlightedMarker=found; highlightedMarker.setIcon(createCustomPin('‚òÖ',true)); map.flyTo([pin.lat,pin.lng],8); highlightedMarker.openPopup();}
        selectedSidebarItem=sidebarItem;
        selectedSidebarItem.classList.remove('bg-gray-700','hover:bg-purple-800'); selectedSidebarItem.classList.add('bg-purple-600','text-white');
        searchResultDiv.textContent=`Pin von ${pin.nickname} hervorgehoben.`;
    } else { searchResultDiv.textContent='Hervorhebung aufgehoben.'; }
}

// Reverse Geocoding
async function reverseGeocode(lat,lng){
    try{
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1&accept-language=de`);
        const data = await res.json();
        const address=data.address;
        const country=address.country||'Unbekannt';
        let continent='Unbekannter Kontinent';
        if(address.continent) continent=address.continent.replace(/ Continent$/,'');
        else if(address.country_code){
            const cc=address.country_code.toUpperCase();
            const m={'DE':'Europa','FR':'Europa','GB':'Europa','ES':'Europa','IT':'Europa','PL':'Europa','US':'Nordamerika','CA':'Nordamerika','MX':'Nordamerika','JP':'Asien','CN':'Asien','IN':'Asien','KR':'Asien','EG':'Afrika','ZA':'Afrika','NG':'Afrika','BR':'S√ºdamerika','AR':'S√ºdamerika','CO':'S√ºdamerika','AU':'Australien','NZ':'Australien'};
            continent=m[cc]||continent;
        }
        return {country,continent};
    }catch(e){ console.error(e); return {country:'Fehler',continent:'Fehler'}; }
}

// Pin setzen Flow
setPinButton.addEventListener('click',()=>{
    showModal('Nickname eingeben','Bitte gib deinen einzigartigen Nickname ein, um fortzufahren.',true,(nickname)=>{
        if(!nickname){showModal('Abgebrochen','Nickname-Eingabe abgebrochen.'); return;}
        if(userPins.some(p=>p.nickname.toLowerCase()===nickname.toLowerCase())){showModal('Fehler',`"${nickname}" ist bereits vergeben.`); currentPinningNickname=null; return;}
        currentPinningNickname=nickname;
        showModal('Karte klicken',`Hallo, ${nickname}! Klicke nun auf die Karte, um deinen Wohnort zu markieren.`);
    });
});

async function onMapClick(e){
    if(!currentPinningNickname) return;
    const {lat,lng}=e.latlng; const nickname=currentPinningNickname;
    showModal('Standort wird ermittelt',`Suche nach Land und Kontinent f√ºr ${lat.toFixed(2)}, ${lng.toFixed(2)}...`,false,null,true);
    const location=await reverseGeocode(lat,lng);
    if(location.country.includes('Fehler')) showModal('Fehler beim Standort',`Konnte Standort f√ºr ${nickname} nicht ermitteln.`);
    else addPin(nickname,lat,lng,location.country,location.continent);
    currentPinningNickname=null;
}

// Suche / Filter
searchLocationInput.addEventListener('input',()=>{
    const q=searchLocationInput.value.trim().toLowerCase();
    if(q.length===0){document.querySelectorAll('.sidebar-pin').forEach(i=>i.classList.remove('hidden')); pinCountSpan.textContent=userPins.length; searchResultDiv.textContent=''; return;}
    let matches=0;
    document.querySelectorAll('.sidebar-pin').forEach(i=>{
        const pin=userPins.find(p=>p.nickname===i.dataset.nickname);
        const match=pin&&(pin.country.toLowerCase().includes(q)||pin.continent.toLowerCase().includes(q));
        if(match){i.classList.remove('hidden'); matches++;}else{i.classList.add('hidden'); if(selectedSidebarItem===i) togglePinHighlightAndZoom(pin,i);}
    });
    searchResultDiv.textContent=matches>0?`${matches} Pins in der Region angezeigt.`:'Keine Pins in der Region gefunden.';
    pinCountSpan.textContent=matches;
});

window.onload=initMap;
</script>

</body>
</html>
